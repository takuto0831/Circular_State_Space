---
title: "How to predict the wind direction of tomorrow"
subtitle: "Tokyo.R #71"
date: "15 July 2018"
author: "Takuto Kotsubo"
output:
  revealjs::revealjs_presentation:
    reveal_option:
      slideNumber: true
      center: true
      font-family: 'Helvetica'
    theme: serif
    # css: /Users/takutokotsubo/Desktop/circular_reg/data/custom.css # for imac
    css: /Users/takuto/Desktop/circular_reg/data/custom.css # for macbook
editor_options: 
  chunk_output_type: console
---

```{r knitr_init, echo=FALSE, cache=FALSE}
## Global options
#options(max.print="500")
rm(list = ls())
knitr:::opts_chunk$set(cache=TRUE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
knitr:::opts_knit$set(width=75)
```

```{r echo=FALSE, cache=FALSE}
# set package
library(revealjs)
library(dplyr)
library(tidyverse)
library(tibble)
library(lubridate)
library(circular)
library(readr)
library(ggthemes)
library(ggforce)
library(MASS)
library(rstan)
library(MCMCpack)
library(loo)
library(ggmcmc)
library(tseries)
library(DT)
library(formattable)

# load function
source('~/Desktop/circular_reg/script/function.R') # 関数読み込み
# source('~/Desktop/circular_reg/script/stan_plot_label_helper.R')
# source('~/Desktop/circular_reg/script/misc.R')
.myfunc.env = new.env() # 関数をグローバル変数に表示しない
sys.source('~/Desktop/circular_reg/script/stan_plot_label_helper.R', envir = .myfunc.env) # stan_ac_labelに必要
sys.source('~/Desktop/circular_reg/script/misc.R', envir = .myfunc.env) # stan_ac_labelに必要
attach( .myfunc.env )
```

```{r echo=FALSE, cache=FALSE}
# set ggplot theme
library(ggplot2)
theme_set(theme_classic(base_size = 14,base_family = "Helvetica"))
```

# Table of content

## Table of content

1. Introduction

2. Introduction of Circular Package and Circular statistics

3. Introduction of Autoregressive model (AR model)

4. Apply the Autoregressive model to the Circular data 

5. Build a Autoregressive model based on the Circular data

6. Analysis for wind direction data

# Introduction

## My profile

<div class="column1">
- Name: Takuto Kotsubo

- Twitter: [airspace_nobo](https://www.inosho.info/濃菜麺-井の庄/)

- Affiliation: Graduate School of Engineering, Tokyo University of Science

- Major: Time series analysis

- Hobby: Shogi, Bouldering
</div>

<div class="column2">
```{r, echo=FALSE, out.width = '75%'}
knitr::include_graphics("data/ramen.png")
knitr::include_graphics("data/bouldering.png")
```
</div>

## Why did I come here ? 

```{r, echo=FALSE, out.width = '75%'}
knitr::include_graphics("data/hongkong.png")
```

## Why did I come here ? 


# Introduction of Circular Package and Circular statistics

## Circular Statistics

- Circular or directional data refers to data recorded as points which directions are measured and arises in biology, geography, medicine, astronomy, and many other areas.
 
- The usual summary statistics, such as the sample mean and standard deviation, cannot be used with angular values.

- The average of the angular values $1$ and $359$ is $0$ not $\pi$.

## Circular plot

- We use `circular` package
- ggplotで作成したものも載せる?

```{r fig.height=4}
x <- circular(data.frame(runif(100,0,pi/2))) 
par(mfcol = c(1,3))
plot(x,main = "Circular plot")
rose.diag(x,main = "rose diagrame")
hist(x %>% as.vector(), main = "Histogram",xlab=expression(theta))
```

## Circular mean direction

<div class="column3">

- We consider the average of the two radians $\pi/3$ and $\pi/5$ (black line)
- Arithmetic average is red line, circular mean direction is blue line

```{r fig.height=5, echo=FALSE}
y <- c(pi/3,pi*5/3)
plot(circular(y),shrink = 1,main="Circular mean direction")
arrows.circular(circular(y))
arrows.circular(circular(0),col=4,cex=100,lty=5)
arrows.circular(circular(pi),col=2,cex=100,lty=5)
```
</div>

<div class="column4">
```{r}
mean(y) 
mean.circular(y) 
```
</div>

## Circular Standard Deviation

- 分散はどのように計算式違うの??

```{r}
x <- runif(100,0,pi/2)
sd(x)
sd.circular(circular(x))
```

## Circular RMSE

- RMSE is a measure of the differences between observed values ($\theta_t$) and predicted values ($\hat{\theta_t}$) by the model,
- 図示しましょう

$$\textrm{RMSE} = \sqrt{\frac{1}{n} \sum_{t=1}^n (\theta^{dif}_t)^2}, $$

where $\theta^{dif}_t$ consider the circular rotations, 

$$ 
\theta^{dif}_t = \begin{cases}
		\theta_t - \hat{\theta_t} + 2 \pi & (\theta_t - \hat{\theta_t}< - \pi) \\
		\theta_t - \hat{\theta_t} & (- \pi \leq \theta_t - \hat{\theta_t}\leq \pi) \\		
		\theta_t - \hat{\theta_t}- 2 \pi & (\theta_t - \hat{\theta_t}> \pi) 
	\end{cases}. 
$$


## Circular test

```{r}
rayleigh.test(x) # 角度データに偏りがあるか
kuiper.test(x) # Whether Circular data follows von Mises distribution
watson.wheeler.test(list(x,x)) # ??
```

## Circular-Linear Regresseion

## Circular-Circular Regresseion

# Introduction of Autoegressive model (AR model)

## Autoregressive process 

- Autoregressive process means that the current data is represented by past data, AR($p$) model can be written as

$$y_t = c + \sum_{i=1}^p \phi_i y_{t-i} + \varepsilon_t,~~ \varepsilon_t \sim \mathcal{N}(0,~\sigma^2).$$

- Joint probability distribution can be written as follows, using value before the time point $t$

$$f(y_1, y_2, ...|c, \phi_i, \varepsilon) = \prod_t f(y_t|y_{t-1}, ...,y_{t-p},c, \phi_i, \varepsilon). $$

## Maximize log likelihood method

- From the time point $t-1$, the value at the time point $t$ as follows, 

$$ y_t|y_{t-1},...,y_{t-p} \sim \mathcal{N}(c + \sum_{i=1}^p \phi_i y_{t-i},~\sigma^2). $$

- Maxtimize the sum of log likelihoods at each time point

## Parameter estimation method

- We use MCMC method, and my rstan code (AR($p$) model) as below,

```
data{
  int N; // data size
  int P; // AR(P) 
  vector[N] theta; // data set
}
parameters{
  real alpha_0; // const parameter
  row_vector[P] alpha_1; // coef parameter
  real<lower=0> sigma; // Variance 
}
model{
  alpha_0 ~ normal(0,100); sigma ~ normal(0,100);
  for(i in 1:P){
    alpha_1[i] ~ normal(0,100); // N(0,100)
  }
  for(n in (1+P):N){
    vector[P] pre_theta; 
    for(k in 1:P){
      pre_theta[k] = theta[n-k];
    }
    target += 
      normal_lpdf(theta[n]|alpha_0 + ( alpha_1 * pre_theta),sigma);
  }
}
generated quantities{
  vector[N-P] log_likelihood;
  for(n in (1+P):N){
    vector[P] pre_theta;
    for(k in 1:P){
      pre_theta[k] = theta[n-k];
    }
    log_likelihood[n-P] = 
      normal_lpdf(theta[n]|alpha_0 + ( alpha_1 * pre_theta),sigma);
  } 
}
```

## Sample data set

- The luteinzing hormone in blood (`lh` data set)
- 10 minutes interbals, 48 samples

```{r include=FALSE}
data(lh) # data import
```

```{r fig.height=3.5}
data.frame(lh) %>% 
    mutate(index = row_number()) %>%
    ggplot(aes(x=index,y=lh)) +
    geom_line()
```

## Estimate AR($p$) model parameters

```{r,echo= FALSE,eval=FALSE}
# fit data 作成コード
ar2_model <- readRDS("model/circular_AR2.rds") 
rstan_options(auto_write=TRUE) # auto save
options(mc.cores=parallel::detectCores()) # multi core
fit1 <- sampling(ar2_model,data = list(N=length(lh),P=1,theta=lh), iter=2000, chains=4)
fit2 <- sampling(ar2_model,data = list(N=length(lh),P=2,theta=lh), iter=2000, chains=4)
fit3 <- sampling(ar2_model,data = list(N=length(lh),P=3,theta=lh), iter=2000, chains=4)
fit4 <- sampling(ar2_model,data = list(N=length(lh),P=4,theta=lh), iter=2000, chains=4)
fit5 <- sampling(ar2_model,data = list(N=length(lh),P=5,theta=lh), iter=2000, chains=4)
fit6 <- sampling(ar2_model,data = list(N=length(lh),P=6,theta=lh), iter=2000, chains=4)
fit7 <- sampling(ar2_model,data = list(N=length(lh),P=7,theta=lh), iter=2000, chains=4)

#### save fit model 
save(fit1, file="fit/AR_1.rda")# save fit
save(fit2, file="fit/AR_2.rda")# save fit
save(fit3, file="fit/AR_3.rda")# save fit
save(fit4, file="fit/AR_4.rda")# save fit
save(fit5, file="fit/AR_5.rda")# save fit
save(fit6, file="fit/AR_6.rda")# save fit
save(fit7, file="fit/AR_7.rda")# save fit

### load fit ###
load("fit/AR_1.rda", verbose = TRUE) 
load("fit/AR_2.rda", verbose = TRUE) 
load("fit/AR_3.rda", verbose = TRUE) 
load("fit/AR_4.rda", verbose = TRUE) 
load("fit/AR_5.rda", verbose = TRUE) 
load("fit/AR_6.rda", verbose = TRUE) 
load("fit/AR_7.rda", verbose = TRUE) 

### WAIC ####
extract_log_lik(fit1,"log_likelihood") %>% loo::waic() # VAR(1) model
extract_log_lik(fit2,"log_likelihood") %>% loo::waic() # VAR(2) model
extract_log_lik(fit3,"log_likelihood") %>% loo::waic() # VAR(3) model
extract_log_lik(fit4,"log_likelihood") %>% loo::waic() # VAR(4) model
extract_log_lik(fit5,"log_likelihood") %>% loo::waic() # VAR(5) model
extract_log_lik(fit6,"log_likelihood") %>% loo::waic() # VAR(6) model
extract_log_lik(fit7,"log_likelihood") %>% loo::waic() # VAR(7) model

### RMSE and plot ### 
pred_value(fit = fit1,p = 1,dat=as.vector(lh),who = 1)
pred_value(fit = fit2,p = 2,dat=as.vector(lh),who = 1)
pred_value(fit = fit3,p = 3,dat=as.vector(lh),who = 1)
pred_value(fit = fit4,p = 4,dat=as.vector(lh),who = 1)
pred_value(fit = fit5,p = 5,dat=as.vector(lh),who = 1)
pred_value(fit = fit6,p = 6,dat=as.vector(lh),who = 1)
pred_value(fit = fit7,p = 7,dat=as.vector(lh),who = 1)
```

<div class="column3">
```{r include=FALSE}
load("fit/AR_3.rda", verbose = TRUE) # load fit
```

```{r echo=FALSE}
pred <- ans_stan_p2(fit3, P=3, data=as.vector(lh))
data.frame(real=as.vector(lh),pred) %>% 
    mutate(index = row_number()) %>%
    ggplot(aes(x=index)) +
    # geom_ribbon(aes(ymin=lower,ymax=upper),fill="skyblue",alpha=0.6) +
    geom_line(aes(y=real, colour= "real")) + 
    geom_line(aes(y=predict, colour= "predict")) +
    scale_colour_manual("",
                        values = c("real"="black","predict"="blue")
    ) +
    labs(y=expression(theta))
```
</div>

<div class="column4">

- $\hat{R} < 1.01$

```{r echo=FALSE}
data_frame(p = c(1,2,3,4,5,6,7),
           WAIC = c(64.6,63.8,63.7,65.2,66.4,65.4,65.4),
           RMSE = c(0.449,0.442,0.436,0.438,0.441,0.430,0.425)) %>% 
  formattable::formattable(list(WAIC = formatter("span",style = x ~ ifelse(x == min(x), style(color = "blue", font.weight = "bold"), NA)),
                                RMSE = formatter("span",style = x ~ ifelse(x == min(x), style(color = "blue", font.weight = "bold"), NA))))
```
</div>

# Apply the Autoregressive model to the Circular data 

## Wind Direction in Col de la Roa

- In a place named "Col de la Roa" in the Italian Alps, It reported the wind direction records every day
- Total of 310 measures

```{r echo=FALSE,fig.height=4}
data(wind) 
wind_data <- wind %>%  
  data.frame(t = seq(1,310,1), tmp=.) %>% # put label
  mutate(theta_real = dplyr::if_else(tmp>pi,tmp - 2*pi, tmp)) %>% 
  dplyr::select(-tmp) %>% 
  mutate(cos_real = cos(theta_real), sin_real=sin(theta_real))

wind_data %>% 
  ggplot(aes(theta_real)) +
  geom_histogram(binwidth = 0.2, colour = "black", fill = "grey") + 
  labs(x="Wind directions in dadians")
```

## Apply the Autoregressive model

```{r eval=FALSE,echo=FALSE}
# read model
ar_model <- readRDS("model/circular_AR.rds")
# fiting
rstan_options(auto_write=TRUE) # auto save
options(mc.cores=parallel::detectCores()) # multi core
fit_ar_1 <- sampling(ar_model,data = d.dat1, iter=2000, chains=4)
fit_ar_2 <- sampling(ar_model,data = d.dat2, iter=2000, chains=4)
fit_ar_3 <- sampling(ar_model,data = d.dat3, iter=2000, chains=4)
fit_ar_4 <- sampling(ar_model,data = d.dat4, iter=2000, chains=4)
fit_ar_5 <- sampling(ar_model,data = d.dat5, iter=2000, chains=4)
fit_ar_6 <- sampling(ar_model,data = d.dat6, iter=2000, chains=4)
fit_ar_7 <- sampling(ar_model,data = d.dat7, iter=2000, chains=4)
#fit_ar_8 <- sampling(ar_model,data = d.dat8, iter=2000, chains=4)
#fit_ar_9 <- sampling(ar_model,data = d.dat9, iter=2000, chains=4)
#fit_ar_10 <- sampling(ar_model,data = d.dat10, iter=2000, chains=4)

#### save fit model 
save(fit_ar_1, file="fit/CircularAR_1.rda")# save fit
save(fit_ar_2, file="fit/CircularAR_2.rda")# save fit
save(fit_ar_3, file="fit/CircularAR_3.rda")# save fit
save(fit_ar_4, file="fit/CircularAR_4.rda")# save fit
save(fit_ar_5, file="fit/CircularAR_5.rda")# save fit
save(fit_ar_6, file="fit/CircularAR_6.rda")# save fit
save(fit_ar_7, file="fit/CircularAR_7.rda")# save fit
#save(fit_ar_8, file="fit/CircularAR_8.rda")# save fit
#save(fit_ar_9, file="fit/CircularAR_9.rda")# save fit
#save(fit_ar_10, file="fit/CircularAR_10.rda")# save fit

### load fit ###
load("fit/CircularAR_1.rda", verbose = TRUE) 
load("fit/CircularAR_2.rda", verbose = TRUE) 
load("fit/CircularAR_3.rda", verbose = TRUE) 
load("fit/CircularAR_4.rda", verbose = TRUE) 
load("fit/CircularAR_5.rda", verbose = TRUE) 
load("fit/CircularAR_6.rda", verbose = TRUE) 
load("fit/CircularAR_7.rda", verbose = TRUE) 
#load("fit/CircularAR_8.rda", verbose = TRUE) 
#load("fit/CircularAR_9.rda", verbose = TRUE) 
#load("fit/CircularAR_10.rda", verbose = TRUE) 

### WAIC ####
extract_log_lik(fit_ar_1,"log_likelihood") %>% loo::waic() # VAR(1) model
extract_log_lik(fit_ar_2,"log_likelihood") %>% loo::waic() # VAR(2) model
extract_log_lik(fit_ar_3,"log_likelihood") %>% loo::waic() # VAR(3) model
extract_log_lik(fit_ar_4,"log_likelihood") %>% loo::waic() # VAR(4) model
extract_log_lik(fit_ar_5,"log_likelihood") %>% loo::waic() # VAR(5) model
extract_log_lik(fit_ar_6,"log_likelihood") %>% loo::waic() # VAR(6) model
extract_log_lik(fit_ar_7,"log_likelihood") %>% loo::waic() # VAR(7) model

### RMSE and plot ### 
pred_value(fit = fit_ar_1,p = 1,dat=wind_data$theta_real,who=1)
pred_value(fit = fit_ar_2,p = 2,dat=wind_data$theta_real,who=1)
pred_value(fit = fit_ar_3,p = 3,dat=wind_data$theta_real,who=1)
pred_value(fit = fit_ar_4,p = 4,dat=wind_data$theta_real,who=1)
pred_value(fit = fit_ar_5,p = 5,dat=wind_data$theta_real,who=1)
pred_value(fit = fit_ar_6,p = 6,dat=wind_data$theta_real,who=1)
pred_value(fit = fit_ar_7,p = 7,dat=wind_data$theta_real,who=1)
```

<div class="column3">
```{r include=FALSE}
load("fit/CircularAR_7.rda", verbose = TRUE) # load fit
```

```{r echo=FALSE}
pred <- ans_stan_p2(fit_ar_7, P=7, data=wind_data$theta_real)
data.frame(real=wind_data$theta_real,pred) %>% 
    mutate(index = row_number()) %>%
    ggplot(aes(x=index)) +
    # geom_ribbon(aes(ymin=lower,ymax=upper),fill="skyblue",alpha=0.6) +
    geom_line(aes(y=real, colour= "real")) + 
    geom_line(aes(y=predict, colour= "predict")) +
    scale_colour_manual("",
                        values = c("real"="black","predict"="blue")
    ) +
    labs(y=expression(theta))
```

- not fitting...

</div>

<div class="column4">

- $\hat{R} < 1.01$

```{r echo=FALSE}
data_frame(p = c(1,2,3,4,5,6,7),
           WAIC = c(890.1,888.2,888.8, 889.8,885.2,888.3,882.5),
           RMSE = c(0.993,0.987,0.989,0.989,0.984,0.980,0.979)) %>% 
  formattable::formattable(list(WAIC = formatter("span",style = x ~ ifelse(x == min(x), style(color = "blue", font.weight = "bold"), NA)),
                                RMSE = formatter("span",style = x ~ ifelse(x == min(x), style(color = "blue", font.weight = "bold"), NA))))
```
</div>

# Build a Auto Regressive model based on the Circular data

# Analysis for wind direction data

## Wind Direction in Col de la Roa

- In a place named "Col de la Roa" in the Italian Alps, It reported the wind direction records every day
- Total of 310 measures

```{r echo=FALSE,fig.height=4}
data(wind) 
wind_data <- wind %>%  
  data.frame(t = seq(1,310,1), tmp=.) %>% # put label
  mutate(theta_real = dplyr::if_else(tmp>pi,tmp - 2*pi, tmp)) %>% 
  dplyr::select(-tmp) %>% 
  mutate(cos_real = cos(theta_real), sin_real=sin(theta_real))

wind_data %>% 
  ggplot(aes(theta_real)) +
  geom_histogram(binwidth = 0.2, colour = "black", fill = "grey") + 
  labs(x="Wind directions in dadians")
```

```{r include=FALSE}
# stan paramter set
d.dat1 <- list(N=length(wind_data$theta_real),P=1,theta=wind_data$theta_real) # for VAR(1)
d.dat2 <- list(N=length(wind_data$theta_real),P=2,theta=wind_data$theta_real) # for VAR(2)
d.dat3 <- list(N=length(wind_data$theta_real),P=3,theta=wind_data$theta_real) # for VAR(3)
d.dat4 <- list(N=length(wind_data$theta_real),P=4,theta=wind_data$theta_real) # for VAR(4)
d.dat5 <- list(N=length(wind_data$theta_real),P=5,theta=wind_data$theta_real) # for VAR(5)
d.dat6 <- list(N=length(wind_data$theta_real),P=6,theta=wind_data$theta_real) # for VAR(6)
d.dat7 <- list(N=length(wind_data$theta_real),P=7,theta=wind_data$theta_real) # for VAR(7)
d.dat8 <- list(N=length(wind_data$theta_real),P=8,theta=wind_data$theta_real) # for VAR(8)
d.dat9 <- list(N=length(wind_data$theta_real),P=9,theta=wind_data$theta_real) # for VAR(9)
d.dat10 <- list(N=length(wind_data$theta_real),P=10,theta=wind_data$theta_real) # for VAR(10)
```

## Autocorrelation of Markov Chains

- parameterの自己相関を一部確認 

```{r include=FALSE}
load("fit/CircularVAR_5.rda", verbose = TRUE) # load fit
```

```{r echo=FALSE,fig.height=4}
pars <- c("alpha_0[1]","alpha_0[2]","alpha_1[1,1]","alpha_1[1,2]","alpha_1[2,1]","alpha_1[2,2]","alpha_1[1,3]","alpha_1[1,4]","alpha_1[2,3]","alpha_1[2,4]")
label_set <- list("alpha_0[1]" = expression(alpha[paste("c,",0)]),"alpha_0[2]" = expression(alpha[paste("s,",0)]),"alpha_1[1,1]" = expression(beta[paste("c,",1,",",1)]), 
                  "alpha_1[1,2]" = expression(beta[paste("c,",1,",",2)]),"alpha_1[2,1]" = expression(beta[paste("s,",1,",",1)]),"alpha_1[2,2]" = expression(beta[paste("s,",1,",",2)]),
                  "alpha_1[1,3]" = expression(beta[paste("c,",2,",",1)]),"alpha_1[1,4]" = expression(beta[paste("c,",2,",",2)]),"alpha_1[2,3]" = expression(beta[paste("s,",2,",",1)]),
                  "alpha_1[2,4]" = expression(beta[paste("s,",2,",",2)]))
label_func <- function(variable, value) return(label_set[value]) # label func
stan_ac_label(object=fit_state_obs_5,pars = pars,label_set = label_func) # stan_ac plot with arbitrary faaet_wrap label
```

## Posterior Distributions

- paraeter の事後分布を一部確認

```{r echo=FALSE,fig.height=4}
stan_plot(fit_state_obs_5,fill_color ="blue",point_est ="median",show_density=T, ci_level = 0.95, outer_level=1.00, show_outer_line =T,
          pars = c("alpha_0[1]","alpha_0[2]","alpha_1[1,1]","alpha_1[1,2]","alpha_1[2,1]","alpha_1[2,2]","alpha_1[1,3]","alpha_1[1,4]","alpha_1[2,3]","alpha_1[2,4]")) + 
  scale_y_continuous(labels = rev(c(expression(alpha[paste("c,",0)]),expression(alpha[paste("s,",0)]),expression(beta[paste("c,",1,",",1)]), 
                                    expression(beta[paste("c,",1,",",2)]),expression(beta[paste("s,",1,",",1)]),expression(beta[paste("s,",1,",",2)]),
                                    expression(beta[paste("c,",2,",",1)]),expression(beta[paste("c,",2,",",2)]),expression(beta[paste("s,",2,",",1)]),
                                    expression(beta[paste("s,",2,",",2)]))), breaks = 1:10)
```

## Apply the Circular-VAR model

```{r eval=FALSE,echo=FALSE}
# read model
state_obs_model <- readRDS("model/state_obs_circular_VAR.rds")

# fiting
rstan_options(auto_write=TRUE) # auto save
options(mc.cores=parallel::detectCores()) # multi core
fit_state_obs_1 <- sampling(state_obs_model,data = d.dat1, iter=5000, chains=4)
fit_state_obs_2 <- sampling(state_obs_model,data = d.dat2, iter=5000, chains=4)
fit_state_obs_3 <- sampling(state_obs_model,data = d.dat3, iter=5000, chains=4)
fit_state_obs_4 <- sampling(state_obs_model,data = d.dat4, iter=5000, chains=4)
fit_state_obs_5 <- sampling(state_obs_model,data = d.dat5, iter=5000, chains=4)
fit_state_obs_6 <- sampling(state_obs_model,data = d.dat6, iter=5000, chains=4)
fit_state_obs_7 <- sampling(state_obs_model,data = d.dat7, iter=5000, chains=4)
fit_state_obs_8 <- sampling(state_obs_model,data = d.dat8, iter=5000, chains=4)
fit_state_obs_9 <- sampling(state_obs_model,data = d.dat9, iter=5000, chains=4)
fit_state_obs_10 <- sampling(state_obs_model,data = d.dat10, iter=5000, chains=4)

#### save fit model 
save(fit_state_obs_1, file="fit/CircularVAR_1.rda")# save fit
save(fit_state_obs_2, file="fit/CircularVAR_2.rda")# save fit
save(fit_state_obs_3, file="fit/CircularVAR_3.rda")# save fit
save(fit_state_obs_4, file="fit/CircularVAR_4.rda")# save fit
save(fit_state_obs_5, file="fit/CircularVAR_5.rda")# save fit
save(fit_state_obs_6, file="fit/CircularVAR_6.rda")# save fit
save(fit_state_obs_7, file="fit/CircularVAR_7.rda")# save fit
save(fit_state_obs_8, file="fit/CircularVAR_8.rda")# save fit
save(fit_state_obs_9, file="fit/CircularVAR_9.rda")# save fit
save(fit_state_obs_10, file="fit/CircularVAR_10.rda")# save fit

### load fit ###
load("fit/CircularVAR_1.rda", verbose = TRUE) 
load("fit/CircularVAR_2.rda", verbose = TRUE) 
load("fit/CircularVAR_3.rda", verbose = TRUE) 
load("fit/CircularVAR_4.rda", verbose = TRUE) 
load("fit/CircularVAR_5.rda", verbose = TRUE) 
load("fit/CircularVAR_6.rda", verbose = TRUE) 
load("fit/CircularVAR_7.rda", verbose = TRUE) 
load("fit/CircularVAR_8.rda", verbose = TRUE) 
load("fit/CircularVAR_9.rda", verbose = TRUE) 
load("fit/CircularVAR_10.rda", verbose = TRUE) 

### WAIC ####
extract_log_lik(fit_state_obs_1,"log_likelihood") %>% loo::waic() # VAR(1) model
extract_log_lik(fit_state_obs_2,"log_likelihood") %>% loo::waic() # VAR(2) model
extract_log_lik(fit_state_obs_3,"log_likelihood") %>% loo::waic() # VAR(3) model
extract_log_lik(fit_state_obs_4,"log_likelihood") %>% loo::waic() # VAR(4) model
extract_log_lik(fit_state_obs_5,"log_likelihood") %>% loo::waic() # VAR(5) model
extract_log_lik(fit_state_obs_6,"log_likelihood") %>% loo::waic() # VAR(6) model
extract_log_lik(fit_state_obs_7,"log_likelihood") %>% loo::waic() # VAR(7) model
extract_log_lik(fit_state_obs_8,"log_likelihood") %>% loo::waic() # VAR(8) model
extract_log_lik(fit_state_obs_9,"log_likelihood") %>% loo::waic() # VAR(9) model
extract_log_lik(fit_state_obs_10,"log_likelihood") %>% loo::waic() # VAR(10) model

### RMSE and plot ### 
pred_value(fit = fit_state_obs_1,p = 1,dat=wind_data$theta_real)
pred_value(fit = fit_state_obs_2,p = 2,dat=wind_data$theta_real)
pred_value(fit = fit_state_obs_3,p = 3,dat=wind_data$theta_real)
pred_value(fit = fit_state_obs_4,p = 4,dat=wind_data$theta_real)
pred_value(fit = fit_state_obs_5,p = 5,dat=wind_data$theta_real)
pred_value(fit = fit_state_obs_6,p = 6,dat=wind_data$theta_real)
pred_value(fit = fit_state_obs_7,p = 7,dat=wind_data$theta_real)
pred_value(fit = fit_state_obs_8,p = 8,dat=wind_data$theta_real)
pred_value(fit = fit_state_obs_9,p = 9,dat=wind_data$theta_real)
pred_value(fit = fit_state_obs_10,p = 10,dat=wind_data$theta_real)
```

<div class="column3">
```{r echo=FALSE,fig.height=4}
pred_value(fit = fit_state_obs_5,p = 5,dat=wind_data$theta_real,dif = FALSE)
```
</div>

<div class="column4">

- $\hat{R} < 1.01$

```{r echo=FALSE}
data_frame(p = c(1,2,3,4,5,6,7,8,9,10),
           WAIC = c(444.2,442.5,435.0,436.6,431.9,437.4,449.6,456.4,466.6,461.3),
           RMSE = c(0.915,0.902,0.908,0.899,0.892,0.884,0.886,0.885,0.886,0.882)) %>% 
   formattable::formattable(list(WAIC = formatter("span",style = x ~ ifelse(x == min(x), style(color = "blue", font.weight = "bold"), NA)),
                                 RMSE = formatter("span",style = x ~ ifelse(x == min(x), style(color = "blue", font.weight = "bold"), NA))))
```
</div>

## Summary

- We get the model...

# Appendix

## Model Selection Criteria (WAIC)

- WAIC can be viewed as an improvement on the DIC for Bayesian models. WAIC can be interpreted as a computationally convenient approximation to cross-validation and is defined as

```{r, echo=FALSE, out.width = '90%'}
knitr::include_graphics("data/WAIC.eps")
```

where $n$ is the number of data $\theta$, $S$ is MCMC sampling number of each parameter, $\eta^{m, S}$ is the $S$-th parameter set of the $m$-th chain.

## table sample

- we calculate WAIC and RMSE

```{r echo=FALSE,eval=FALSE}
DT::datatable(data_frame(WAIC = c(1,2,3,4,5,6,7,8,9,0),
                         RMSE = c(1,2,3,4,5,6,7,8,9,0)),
              rownames = TRUE,
              colnames = c('p'=1),
              filter = "none",
              escape = FALSE,
              extensions = 'Scroller',
              options=list(pageLength=5,deferRender = TRUE,
                           dom = "frtiS",scrollY = 200,scrollCollapse = TRUE)) 
```










