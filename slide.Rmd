---
title: "How to predict the wind direction of tomorrow"
subtitle: "Tokyo.R #71"
date: "15 July 2018"
author: "Takuto Kotsubo"
output:
  revealjs::revealjs_presentation:
    reveal_option:
      slideNumber: true
      center: true
      font-family: 'Helvetica'
    theme: serif
    #css: /Users/takutokotsubo/Desktop/circular_reg/data/custom.css # for imac
    css: /Users/takuto/Desktop/circular_reg/data/custom.css # for macbook
editor_options: 
  chunk_output_type: console
---

```{r knitr_init, echo=FALSE, cache=FALSE}
## Global options
#options(max.print="500")
rm(list = ls())
knitr:::opts_chunk$set(cache=TRUE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
knitr:::opts_knit$set(width=75)
```

```{r include=FALSE}
# set package
library(revealjs)
library(dplyr)
library(tidyverse)
library(tibble)
library(lubridate)
library(circular)
library(readr)
library(ggthemes)
library(ggforce)
library(MASS)
library(rstan)
library(MCMCpack)
library(loo)
library(ggmcmc)
library(tseries)
```

```{r echo=FALSE, cache=FALSE}
# set ggplot theme
library(ggplot2)
theme_set(theme_classic(base_size = 14,base_family = "Helvetica"))
```

# Table of content

## Table of content

- My profile

- Introduction of Circular Package and Circular statistics

- Introduction of Autoregressive model (AR model)

- Apply the Autoregressive model to the Circular data 

- Build a Autoregressive model based on the Circular data

- Analysis for wind direction data

# My profile

## My profile

<div class="column1">
- Name: Takuto Kotsubo

- Twitter: [airspace_nobo](https://www.inosho.info/濃菜麺-井の庄/)

- Affiliation: Graduate School of Engineering, Tokyo University of Science

- Major: Time series analysis

- Hobby: Shogi, Bouldering
</div>

<div class="column2">
```{r, echo=FALSE, out.width = '75%'}
knitr::include_graphics("data/ramen.png")
knitr::include_graphics("data/bouldering.png")
```
</div>

# Introduction of Circular Package and Circular statistics

## Circular Statistics

## Circular plot

```{r fig.height=4}
x <- circular(data.frame(runif(100,0,pi/2))) 
par(mfcol = c(1,3))
plot(x,main = "Circular plot")
rose.diag(x,main = "rose diagrame")
hist(x %>% as.vector(), main = "Histogram",xlab=expression(theta))
```

## Circular mean direction

<div class="column3">

- We consider the average of the two radians $\pi/3$ and $\pi/5$ (black line)
- Arithmetic average is red line, circular mean direction is blue line

```{r fig.height=5, echo=FALSE}
y <- c(pi/3,pi*5/3)
plot(circular(y),shrink = 1,main="Circular mean direction")
arrows.circular(circular(y))
arrows.circular(circular(0),col=4,cex=100,lty=5)
arrows.circular(circular(pi),col=2,cex=100,lty=5)
```
</div>

<div class="column4">
```{r}
mean(y) 
mean.circular(y) 
```
</div>

## Circular Standard Deviation

- 分散はどのように計算式違うの??

```{r}
x <- runif(100,0,pi/2)
sd(x)
sd.circular(circular(x))
```

## Circular MSE

we consider circular rotation, for example 


## Circular test

```{r}
rayleigh.test(x) # 角度データに偏りがあるか
kuiper.test(x) # Whether Circular data follows von Mises distribution
watson.wheeler.test(list(x,x)) # ??
```

## Circular-Linear Regresseion

## Circular-Circular Regresseion

# Introduction of Autoegressive model (AR model)

## Autoregressive process 

- Autoregressive process means that the current data is represented by past data, AR($p$) model can be written as

$$y_t = c + \sum_{i=1}^p \phi_i y_{t-i} + \varepsilon_t,~~ \varepsilon_t \sim \mathcal{N}(0,~\sigma^2).$$

- Joint probability distribution can be written as follows, using value before the time point $t$

$$f(y_1, y_2, ...|c, \phi_i, \varepsilon) = \prod_t f(y_t|y_{t-1}, ...,y_{t-p},c, \phi_i, \varepsilon). $$

## Maximize log likelihood method

- From the time point $t-1$, the value at the time point $t$ as follows, 

$$ y_t|y_{t-1},...,y_{t-p} \sim \mathcal{N}(c + \sum_{i=1}^p \phi_i y_{t-i},~\sigma^2). $$

- Maxtimize the sum of log likelihoods at each time point

## Parameter estimation method by MCMC

- Rstan code (AR($p$) model)

```
data{
  int N; // data size
  int P; // AR(P) 
  vector[N] theta; // data set
}
parameters{
  real alpha_0; // const parameter
  row_vector[P] alpha_1; // coef parameter
  real<lower=0> sigma; // Variance 
}
model{
  alpha_0 ~ normal(0,100); sigma ~ normal(0,100);
  for(i in 1:P){
    alpha_1[i] ~ normal(0,100); // N(0,100)
  }
  for(n in (1+P):N){
    vector[P] pre_theta; 
    for(k in 1:P){
      pre_theta[k] = theta[n-k];
    }
    target += 
      normal_lpdf(theta[n]|alpha_0 + ( alpha_1 * pre_theta),sigma);
  }
}
generated quantities{
  vector[N-P] log_likelihood;
  for(n in (1+P):N){
    vector[P] pre_theta;
    for(k in 1:P){
      pre_theta[k] = theta[n-k];
    }
    log_likelihood[n-P] = 
      normal_lpdf(theta[n]|alpha_0 + ( alpha_1 * pre_theta),sigma);
  } 
}
```

## Sample data set

- The luteinzing hormone in blood (`lh` data set)
- 10 minutes interbals, 48 samples

```{r include=FALSE}
data(lh) # data import
```

```{r fig.height=3.5}
data.frame(lh) %>% 
    mutate(index = row_number()) %>%
    ggplot(aes(x=index,y=lh)) +
    geom_line()
```

## Estimate AR($p$) model parameters

まだ動かないよ

```{r,eval=FALSE}
fit1 <- sampling(ar2_model,data = list(N=length(lh),P=1,theta=lh), iter=1000, chains=1)
fit2 <- sampling(ar2_model,data = list(N=length(lh),P=2,theta=lh), iter=1000, chains=1)
fit3 <- sampling(ar2_model,data = list(N=length(lh),P=3,theta=lh), iter=1000, chains=1)
fit4 <- sampling(ar2_model,data = list(N=length(lh),P=4,theta=lh), iter=1000, chains=1)
fit5 <- sampling(ar2_model,data = list(N=length(lh),P=5,theta=lh), iter=1000, chains=1)

ms <- rstan::extract(fit3)
ms <- as.ts(c(NA,ms$theta_new %>% apply(2,mean)))
ts.plot(lh,ms,col=c(1,2))
pred_value(fit = fit3,p = 3,dat=as.vector(lh),who = 1)

extract_log_lik(fit1,"log_likelihood") %>% loo::waic() # VAR(1) model
extract_log_lik(fit2,"log_likelihood") %>% loo::waic() # VAR(2) model
extract_log_lik(fit3,"log_likelihood") %>% loo::waic() # VAR(3) model
extract_log_lik(fit4,"log_likelihood") %>% loo::waic() # VAR(4) model
extract_log_lik(fit5,"log_likelihood") %>% loo::waic() # VAR(5) model
```

# Apply the Auto Regressive model to the Circular data 

# Build a Auto Regressive model based on the Circular data

# Analysis for wind direction data


## table sample

- we calculate WAIC and RMSE

```{r echo=FALSE}
library(DT)
DT::datatable(data_frame(WAIC = c(1,2,3,4,5,6,7,8,9,0),
                         RMSE = c(1,2,3,4,5,6,7,8,9,0)),
              rownames = TRUE,
              colnames = c('p'=1),
              filter = "none",
              escape = FALSE,
              extensions = 'Scroller',
              options=list(pageLength=5,deferRender = TRUE,
                           dom = "frtiS",scrollY = 200,scrollCollapse = TRUE)) 
```
