---
title: "Circular Regression Simulate"
author: "kotsubo takuto"
date: "`r Sys.Date()`"
output: 
    html_document:
      md_extensions: -ascii_identifiers
      toc: true
      toc_depth: 3
---

```{r option, echo=FALSE, cache=FALSE, warning=FALSE}
library(knitr)
rm(list=ls())
## Global options
options(max.print="75")
opts_chunk$set(echo=TRUE,
               #cache = TRUE, # 現状大きな計算はしていないので
	             prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=75)
```

```{r,echo=FALSE}
library(dplyr)
library(tidyverse)
library(pipeR)
library(lubridate)
library(circular)
library(foreach)
library(MASS)
library(DT)
library(ggthemes)
source('~/Desktop/circular_reg/script/function.R') # 関数読み込み
```

# Circular regression model

以下の式で, 表されるcircular regression modelによる時系列データを生成する.

$$
\left(
  \begin{array}{c}
    \cos \theta_t \\
    \sin \theta_t
  \end{array}
\right) =
\left(
  \begin{array}{c}
    \alpha_{c,0} \\
    \alpha_{s,0}
  \end{array} 
\right) +
\left(
  \begin{array}{cc}
    \beta_{c,1,1} & \beta_{c,1,2} \\
    \beta_{s,1,1} & \beta_{s,1,2}
  \end{array}
\right)
\left(
  \begin{array}{c}
    \cos \theta_{t-1} \\
    \sin \theta_{t-1}
  \end{array} 
\right) +
\left(
  \begin{array}{cc}
    \beta_{c,2,1} & \beta_{c,2,2} \\
    \beta_{s,2,1} & \beta_{s,2,2}
  \end{array} 
\right)
\left(
  \begin{array}{c}
    \cos \theta_{t-2} \\
    \sin \theta_{t-2}
  \end{array} 
\right) \\ + \cdots +
\left(
  \begin{array}{cc}
    \beta_{c,p,1} & \beta_{c,p,2} \\
    \beta_{s,p,1} & \beta_{s,p,2}
  \end{array}
\right)
\left(
  \begin{array}{c}
    \cos \theta_{t-p} \\
    \sin \theta_{t-p}
  \end{array} 
\right) +
\left(  
  \begin{array}{c}
    \varepsilon_{c,t} \\
    \varepsilon_{s,t}
  \end{array}
\right)
$$

式中の説明, $\boldsymbol{\varepsilon} = 
\left(  
  \begin{array}{c}
    \varepsilon_{c,t} \\
    \varepsilon_{s,t}
  \end{array}
\right)$の定義

$$
\left(
  \begin{array}{c}
    \varepsilon_{c,t} \\
    \varepsilon_{s,t}
  \end{array} 
\right) \sim 
N 
\left(
  \left(
    \begin{array}{c}
      0 \\
      0
    \end{array}
  \right),
  \left(
    \begin{array}{cc}
      \sigma_c^2 & \rho \sigma_c \sigma_s \\
      \rho \sigma_c \sigma_s & \sigma_s^2
    \end{array}
  \right)
\right)
$$

# Generate simulation data

パラメータは, 

$$ \alpha_{c,0}, \alpha_{s,0}, \left(
  \begin{array}{cc}
    \beta_{c,1,1} & \beta_{c,1,2} \\
    \beta_{s,1,1} & \beta_{s,1,2}
  \end{array}
\right), \cdots , \left(
  \begin{array}{cc}
    \beta_{c,p,1} & \beta_{c,p,2} \\
    \beta_{s,p,1} & \beta_{s,p,2}
  \end{array}
\right), \sigma_c, \sigma_s, \rho $$

であり, 以下のように定義する. ここで$p=1$とする.

```{r parameter setting}
# model parameter
alpha <- matrix(c(0,0), nrow = 2)
beta <- array(c(0.5,0.1,
                0.2,0.25),dim = c(2,2,1))
Eps <- GeneratingEps(sigma_c=1, sigma_s=1.5, rho=0.5)

# Simulation parameter
theta_start_vec <- c(0) # 初期値
len <- 200 # 返す乱数列の長さ(初期値も含む)
```

パラメーターを元に, シミューレーションデータを生成する.

```{r}
CircularRegSim # 関数
```

```{r}
Sim_data <- CircularRegSim(theta_start_vec,len,alpha,beta,Eps)
Sim_data %>% 
  t() %>% 
  as.data.frame() %>% 
  DT::datatable(rownames = FALSE,
                colnames = c("p","cos(theta)","sin(theta)"))
```

$- 1 \leq \cos \theta, \sin \theta \leq 1$を全然満たしていない.

単位円ではなく, 半径$r$上に存在すると考えると, $\arctan(r\sin\theta/r \cos\theta) = \theta$で求められる?? (link function??)

```{r}
Sim_data %>% 
  t() %>% 
  as.data.frame() %>%
  rename(p=V1, cos=V2, sin=V3) %>% 
  mutate(theta = atan2(sin,cos)) -> Sim_data
```

```{r}
Sim_data %>% 
  DT::datatable(rownames = FALSE)
```

# Time Series Plot

Sim_dataにおける, `theta`, `sin`, `cos`について時系列データとして見てみる.

```{r}
Sim_data %>% 
  ggplot(aes(x=p,y=theta)) +
   geom_line() + 
   theme_economist() +
   labs(title = "time series circular plot")
```

```{r}
Sim_data %>% 
  tidyr::gather(key = "variable",value  = value, cos,sin) %>% 
  ggplot(aes(x=p,y=value,colour=variable)) +
   geom_line() + 
   theme_economist() +
   labs(title = "time series circular plot")
```

# estimate for stan


```{r set data list, eval=FALSE}
d.dat1 <- list(N=length(Sim_data$theta),P=1,theta=Sim_data$theta) # for VAR(1)
d.dat2 <- list(N=length(Sim_data$theta),P=2,theta=Sim_data$theta) # for VAR(2)
d.dat3 <- list(N=length(Sim_data$theta),P=3,theta=Sim_data$theta) # for VAR(3)
```

```{r stan test, eval=FALSE,include=FALSE}
#fit<-stan(file='stan/test.stan',data=d.dat,iter=1000,chains=1) # sigma(2,2) に対して1を仮定する
#fit<-stan(file='stan/test1.stan',data=d.dat,iter=4000,chains=1) # 分散共分散行列の過程
# compile model
model1 <- stan_model('stan/circularVAR_p.stan')
model2 <- stan_model('stan/circularVAR_p_.stan')
model3 <- stan_model('stan/circularVAR_p_penalty.stan')
# fitting stan model
fit1_1 <- sampling(model1, data = d.dat1, iter=1000, chains=1) # Execute model
fit2_1 <- sampling(model1, data = d.dat2, iter=1000, chains=1) # Execute model 
fit1_2 <- sampling(model2, data = d.dat1, iter=1000, chains=1) # Execute model
fit2_2 <- sampling(model2, data = d.dat2, iter=1000, chains=1) # Execute model
fit1_3 <- sampling(model3, data = c(d.dat1,lambda=1), iter=1000, chains=1) # Execute model
fit2_3 <- sampling(model3, data = c(d.dat2,lambda=1), iter=1000, chains=1) # Execute model
fit3_3 <- sampling(model3, data = c(d.dat3,lambda=1), iter=1000, chains=1) # Execute model
```

```{r}
options(max.print = 200)
fit1_2
fit2_2
# fit2_1
# fit2_2
# fit2_3
```

```{r}
pred_value(fit = fit1_2,p = 1,dat=Sim_data$theta)
pred_value(fit = fit2_2,p = 2,dat=Sim_data$theta)
```

```{r}
pred_value(fit = fit1_3,p = 1,dat=Sim_data$theta)
pred_value(fit = fit2_3,p = 2,dat=Sim_data$theta)
pred_value(fit = fit3_3,p = 3,dat=Sim_data$theta)
```

